//
// Created by Valerio Santinelli on 02/02/2020.
//

#include <string.h>
#include "binocle_input_wrap.h"
#include "binocle_lua.h"
#include "binocle_input.h"
#include "binocle_sdl.h"
#include "binocle_camera_wrap.h"
#include "binocle_camera.h"

static const char* binocle_input_keyboard_key_str[] = {
  "KEY_UNKNOWN",
  "KEY_A",
  "KEY_B",
  "KEY_C",
  "KEY_D",
  "KEY_E",
  "KEY_F",
  "KEY_G",
  "KEY_H",
  "KEY_I",
  "KEY_J",
  "KEY_K",
  "KEY_L",
  "KEY_M",
  "KEY_N",
  "KEY_O",
  "KEY_P",
  "KEY_Q",
  "KEY_R",
  "KEY_S",
  "KEY_T",
  "KEY_U",
  "KEY_V",
  "KEY_W",
  "KEY_X",
  "KEY_Y",
  "KEY_Z",
  "KEY_1",
  "KEY_2",
  "KEY_3",
  "KEY_4",
  "KEY_5",
  "KEY_6",
  "KEY_7",
  "KEY_8",
  "KEY_9",
  "KEY_0",
  "KEY_RETURN",
  "KEY_ESCAPE",
  "KEY_BACKSPACE",
  "KEY_TAB",
  "KEY_SPACE",
  "KEY_MINUS",
  "KEY_EQUALS",
  "KEY_LEFTBRACKET",
  "KEY_RIGHTBRACKET",
  "KEY_BACKSLASH",
  "KEY_NONUSHASH",
  "KEY_SEMICOLON",
  "KEY_APOSTROPHE",
  "KEY_GRAVE",
  "KEY_COMMA",
  "KEY_PERIOD",
  "KEY_SLASH",
  "KEY_CAPSLOCK",
  "KEY_F1",
  "KEY_F2",
  "KEY_F3",
  "KEY_F4",
  "KEY_F5",
  "KEY_F6",
  "KEY_F7",
  "KEY_F8",
  "KEY_F9",
  "KEY_F10",
  "KEY_F11",
  "KEY_F12",
  "KEY_PRINTSCREEN",
  "KEY_SCROLLLOCK",
  "KEY_PAUSE",
  "KEY_INSERT",
  "KEY_HOME",
  "KEY_PAGEUP",
  "KEY_DELETE",
  "KEY_END",
  "KEY_PAGEDOWN",
  "KEY_RIGHT",
  "KEY_LEFT",
  "KEY_DOWN",
  "KEY_UP",
  "KEY_NUMLOCKCLEAR",
  "KEY_KEYPAD_DIVIDE",
  "KEY_KEYPAD_MULTIPLY",
  "KEY_KEYPAD_MINUS",
  "KEY_KEYPAD_PLUS",
  "KEY_KEYPAD_ENTER",
  "KEY_KEYPAD_1",
  "KEY_KEYPAD_2",
  "KEY_KEYPAD_3",
  "KEY_KEYPAD_4",
  "KEY_KEYPAD_5",
  "KEY_KEYPAD_6",
  "KEY_KEYPAD_7",
  "KEY_KEYPAD_8",
  "KEY_KEYPAD_9",
  "KEY_KEYPAD_0",
  "KEY_KEYPAD_PERIOD",
  "KEY_NONUSBACKSLASH",
  "KEY_APPLICATION",
  "KEY_POWER",
  "KEY_KEYPAD_EQUALS",
  "KEY_F13",
  "KEY_F14",
  "KEY_F15",
  "KEY_F16",
  "KEY_F17",
  "KEY_F18",
  "KEY_F19",
  "KEY_F20",
  "KEY_F21",
  "KEY_F22",
  "KEY_F23",
  "KEY_F24",
  "KEY_EXECUTE_EX",
  "KEY_HELP",
  "KEY_MENU",
  "KEY_SELECT",
  "KEY_STOP",
  "KEY_AGAIN",
  "KEY_UNDO",
  "KEY_CUT",
  "KEY_COPY",
  "KEY_PASTE",
  "KEY_FIND",
  "KEY_MUTE",
  "KEY_VOLUMEUP",
  "KEY_VOLUMEDOWN",
  "KEY_KEYPAD_COMMA",
  "KEY_KEYPAD_EQUALSAS400",
  "KEY_INTERNATIONAL1",
  "KEY_INTERNATIONAL2",
  "KEY_INTERNATIONAL3",
  "KEY_INTERNATIONAL4",
  "KEY_INTERNATIONAL5",
  "KEY_INTERNATIONAL6",
  "KEY_INTERNATIONAL7",
  "KEY_INTERNATIONAL8",
  "KEY_INTERNATIONAL9",
  "KEY_LANG1",
  "KEY_LANG2",
  "KEY_LANG3",
  "KEY_LANG4",
  "KEY_LANG5",
  "KEY_LANG6",
  "KEY_LANG7",
  "KEY_LANG8",
  "KEY_LANG9",
  "KEY_ALTERASE",
  "KEY_SYSREQ",
  "KEY_CANCEL",
  "KEY_CLEAR",
  "KEY_PRIOR",
  "KEY_RETURN2",
  "KEY_SEPARATOR",
  "KEY_OUT",
  "KEY_OPER",
  "KEY_CLEARAGAIN",
  "KEY_CRSEL",
  "KEY_EXSEL",
  "KEY_KEYPAD_00",
  "KEY_KEYPAD_000",
  "KEY_THOUSANDSSEPARATOR",
  "KEY_DECIMALSEPARATOR",
  "KEY_CURRENCYUNIT",
  "KEY_CURRENCYSUBUNIT",
  "KEY_KEYPAD_LEFTPAREN",
  "KEY_KEYPAD_RIGHTPAREN",
  "KEY_KEYPAD_LEFTBRACE",
  "KEY_KEYPAD_RIGHTBRACE",
  "KEY_KEYPAD_TAB",
  "KEY_KEYPAD_BACKSPACE",
  "KEY_KEYPAD_A",
  "KEY_KEYPAD_B",
  "KEY_KEYPAD_C",
  "KEY_KEYPAD_D",
  "KEY_KEYPAD_E",
  "KEY_KEYPAD_F",
  "KEY_KEYPAD_XOR",
  "KEY_KEYPAD_POWER",
  "KEY_KEYPAD_PERCENT",
  "KEY_KEYPAD_LESS",
  "KEY_KEYPAD_GREATER",
  "KEY_KEYPAD_AMPERSAND",
  "KEY_KEYPAD_DBLAMPERSAND",
  "KEY_KEYPAD_VERTICALBAR",
  "KEY_KEYPAD_DBLVERTICALBAR",
  "KEY_KEYPAD_COLON",
  "KEY_KEYPAD_HASH",
  "KEY_KEYPAD_SPACE",
  "KEY_KEYPAD_AT",
  "KEY_KEYPAD_EXCLAM",
  "KEY_KEYPAD_MEMSTORE",
  "KEY_KEYPAD_MEMRECALL",
  "KEY_KEYPAD_MEMCLEAR",
  "KEY_KEYPAD_MEMADD",
  "KEY_KEYPAD_MEMSUBTRACT",
  "KEY_KEYPAD_MEMMULTIPLY",
  "KEY_KEYPAD_MEMDIVIDE",
  "KEY_KEYPAD_PLUSMINUS",
  "KEY_KEYPAD_CLEAR",
  "KEY_KEYPAD_CLEARENTRY",
  "KEY_KEYPAD_BINARY",
  "KEY_KEYPAD_OCTAL",
  "KEY_KEYPAD_DECIMAL",
  "KEY_KEYPAD_HEXADECIMAL",
  "KEY_LEFT_CTRL",
  "KEY_LEFT_SHIFT",
  "KEY_LEFT_ALT",
  "KEY_LEFT_GUI",
  "KEY_RIGHT_CTRL",
  "KEY_RIGHT_SHIFT",
  "KEY_RIGHT_ALT",
  "KEY_RIGHT_GUI",
  "KEY_MODE",
  "KEY_AUDIONEXT",
  "KEY_AUDIOPREV",
  "KEY_AUDIOSTOP",
  "KEY_AUDIOPLAY",
  "KEY_AUDIOMUTE",
  "KEY_MEDIASELECT",
  "KEY_WWW",
  "KEY_MAIL",
  "KEY_CALCULATOR",
  "KEY_COMPUTER",
  "KEY_AC_SEARCH",
  "KEY_AC_HOME",
  "KEY_AC_BACK",
  "KEY_AC_FORWARD",
  "KEY_AC_STOP",
  "KEY_AC_REFRESH",
  "KEY_AC_BOOKMARKS",
  "KEY_BRIGHTNESSDOWN",
  "KEY_BRIGHTNESSUP",
  "KEY_DISPLAYSWITCH",
  "KEY_KBDILLUMTOGGLE",
  "KEY_KBDILLUMDOWN",
  "KEY_KBDILLUMUP",
  "KEY_EJECT",
  "KEY_SLEEP",
  "KEY_APP1",
  "KEY_APP2",
  "KEY_MAX",
  NULL
};

static enum binocle_input_keyboard_key binocle_input_keyboard_key_val[] = {
  KEY_UNKNOWN,
  KEY_A,
  KEY_B,
  KEY_C,
  KEY_D,
  KEY_E,
  KEY_F,
  KEY_G,
  KEY_H,
  KEY_I,
  KEY_J,
  KEY_K,
  KEY_L,
  KEY_M,
  KEY_N,
  KEY_O,
  KEY_P,
  KEY_Q,
  KEY_R,
  KEY_S,
  KEY_T,
  KEY_U,
  KEY_V,
  KEY_W,
  KEY_X,
  KEY_Y,
  KEY_Z,
  KEY_1,
  KEY_2,
  KEY_3,
  KEY_4,
  KEY_5,
  KEY_6,
  KEY_7,
  KEY_8,
  KEY_9,
  KEY_0,
  KEY_RETURN,
  KEY_ESCAPE,
  KEY_BACKSPACE,
  KEY_TAB,
  KEY_SPACE,
  KEY_MINUS,
  KEY_EQUALS,
  KEY_LEFTBRACKET,
  KEY_RIGHTBRACKET,
  KEY_BACKSLASH,
  KEY_NONUSHASH,
  KEY_SEMICOLON,
  KEY_APOSTROPHE,
  KEY_GRAVE,
  KEY_COMMA,
  KEY_PERIOD,
  KEY_SLASH,
  KEY_CAPSLOCK,
  KEY_F1,
  KEY_F2,
  KEY_F3,
  KEY_F4,
  KEY_F5,
  KEY_F6,
  KEY_F7,
  KEY_F8,
  KEY_F9,
  KEY_F10,
  KEY_F11,
  KEY_F12,
  KEY_PRINTSCREEN,
  KEY_SCROLLLOCK,
  KEY_PAUSE,
  KEY_INSERT,
  KEY_HOME,
  KEY_PAGEUP,
  KEY_DELETE,
  KEY_END,
  KEY_PAGEDOWN,
  KEY_RIGHT,
  KEY_LEFT,
  KEY_DOWN,
  KEY_UP,
  KEY_NUMLOCKCLEAR,
  KEY_KEYPAD_DIVIDE,
  KEY_KEYPAD_MULTIPLY,
  KEY_KEYPAD_MINUS,
  KEY_KEYPAD_PLUS,
  KEY_KEYPAD_ENTER,
  KEY_KEYPAD_1,
  KEY_KEYPAD_2,
  KEY_KEYPAD_3,
  KEY_KEYPAD_4,
  KEY_KEYPAD_5,
  KEY_KEYPAD_6,
  KEY_KEYPAD_7,
  KEY_KEYPAD_8,
  KEY_KEYPAD_9,
  KEY_KEYPAD_0,
  KEY_KEYPAD_PERIOD,
  KEY_NONUSBACKSLASH,
  KEY_APPLICATION,
  KEY_POWER,
  KEY_KEYPAD_EQUALS,
  KEY_F13,
  KEY_F14,
  KEY_F15,
  KEY_F16,
  KEY_F17,
  KEY_F18,
  KEY_F19,
  KEY_F20,
  KEY_F21,
  KEY_F22,
  KEY_F23,
  KEY_F24,
  KEY_EXECUTE_EX,
  KEY_HELP,
  KEY_MENU,
  KEY_SELECT,
  KEY_STOP,
  KEY_AGAIN,
  KEY_UNDO,
  KEY_CUT,
  KEY_COPY,
  KEY_PASTE,
  KEY_FIND,
  KEY_MUTE,
  KEY_VOLUMEUP,
  KEY_VOLUMEDOWN,
  KEY_KEYPAD_COMMA,
  KEY_KEYPAD_EQUALSAS400,
  KEY_INTERNATIONAL1,
  KEY_INTERNATIONAL2,
  KEY_INTERNATIONAL3,
  KEY_INTERNATIONAL4,
  KEY_INTERNATIONAL5,
  KEY_INTERNATIONAL6,
  KEY_INTERNATIONAL7,
  KEY_INTERNATIONAL8,
  KEY_INTERNATIONAL9,
  KEY_LANG1,
  KEY_LANG2,
  KEY_LANG3,
  KEY_LANG4,
  KEY_LANG5,
  KEY_LANG6,
  KEY_LANG7,
  KEY_LANG8,
  KEY_LANG9,
  KEY_ALTERASE,
  KEY_SYSREQ,
  KEY_CANCEL,
  KEY_CLEAR,
  KEY_PRIOR,
  KEY_RETURN2,
  KEY_SEPARATOR,
  KEY_OUT,
  KEY_OPER,
  KEY_CLEARAGAIN,
  KEY_CRSEL,
  KEY_EXSEL,
  KEY_KEYPAD_00,
  KEY_KEYPAD_000,
  KEY_THOUSANDSSEPARATOR,
  KEY_DECIMALSEPARATOR,
  KEY_CURRENCYUNIT,
  KEY_CURRENCYSUBUNIT,
  KEY_KEYPAD_LEFTPAREN,
  KEY_KEYPAD_RIGHTPAREN,
  KEY_KEYPAD_LEFTBRACE,
  KEY_KEYPAD_RIGHTBRACE,
  KEY_KEYPAD_TAB,
  KEY_KEYPAD_BACKSPACE,
  KEY_KEYPAD_A,
  KEY_KEYPAD_B,
  KEY_KEYPAD_C,
  KEY_KEYPAD_D,
  KEY_KEYPAD_E,
  KEY_KEYPAD_F,
  KEY_KEYPAD_XOR,
  KEY_KEYPAD_POWER,
  KEY_KEYPAD_PERCENT,
  KEY_KEYPAD_LESS,
  KEY_KEYPAD_GREATER,
  KEY_KEYPAD_AMPERSAND,
  KEY_KEYPAD_DBLAMPERSAND,
  KEY_KEYPAD_VERTICALBAR,
  KEY_KEYPAD_DBLVERTICALBAR,
  KEY_KEYPAD_COLON,
  KEY_KEYPAD_HASH,
  KEY_KEYPAD_SPACE,
  KEY_KEYPAD_AT,
  KEY_KEYPAD_EXCLAM,
  KEY_KEYPAD_MEMSTORE,
  KEY_KEYPAD_MEMRECALL,
  KEY_KEYPAD_MEMCLEAR,
  KEY_KEYPAD_MEMADD,
  KEY_KEYPAD_MEMSUBTRACT,
  KEY_KEYPAD_MEMMULTIPLY,
  KEY_KEYPAD_MEMDIVIDE,
  KEY_KEYPAD_PLUSMINUS,
  KEY_KEYPAD_CLEAR,
  KEY_KEYPAD_CLEARENTRY,
  KEY_KEYPAD_BINARY,
  KEY_KEYPAD_OCTAL,
  KEY_KEYPAD_DECIMAL,
  KEY_KEYPAD_HEXADECIMAL,
  KEY_LEFT_CTRL,
  KEY_LEFT_SHIFT,
  KEY_LEFT_ALT,
  KEY_LEFT_GUI,
  KEY_RIGHT_CTRL,
  KEY_RIGHT_SHIFT,
  KEY_RIGHT_ALT,
  KEY_RIGHT_GUI,
  KEY_MODE,
  KEY_AUDIONEXT,
  KEY_AUDIOPREV,
  KEY_AUDIOSTOP,
  KEY_AUDIOPLAY,
  KEY_AUDIOMUTE,
  KEY_MEDIASELECT,
  KEY_AC_SEARCH,
  KEY_AC_HOME,
  KEY_AC_BACK,
  KEY_AC_FORWARD,
  KEY_AC_STOP,
  KEY_AC_REFRESH,
  KEY_AC_BOOKMARKS,
  KEY_EJECT,
  KEY_SLEEP,
  KEY_MAX,
  0
};

static const char* binocle_input_mouse_button_str[] = {
  "MOUSE_LEFT",
  "MOUSE_MIDDLE",
  "MOUSE_RIGHT",
  NULL
};

static enum binocle_input_mouse_button binocle_input_mouse_button_val[] = {
  MOUSE_LEFT,
  MOUSE_MIDDLE,
  MOUSE_RIGHT,
  0
};

int l_binocle_input_new(lua_State *L) {
  l_binocle_input_t *input = lua_newuserdata(L, sizeof(l_binocle_input_t));
  lua_getfield(L, LUA_REGISTRYINDEX, "binocle_input");
  lua_setmetatable(L, -2);
  SDL_memset(input, 0, sizeof(*input));
  binocle_input i = binocle_input_new();
  input->input = SDL_malloc(sizeof(binocle_input));
  SDL_memcpy(input->input, &i, sizeof(binocle_input));
  return 1;
}

int l_binocle_input_is_key_pressed(lua_State *L) {
  l_binocle_input_t *input = lua_touserdata(L, 1);
  int key_int = luaL_checkoption(L, 2, "KEY_UNKNOWN", binocle_input_keyboard_key_str);
  binocle_input_keyboard_key key = binocle_input_keyboard_key_val[key_int];
  bool res = binocle_input_is_key_pressed(input->input, key);
  lua_pushboolean(L, res);
  return 1;
}

int l_binocle_input_is_key_down(lua_State *L) {
  l_binocle_input_t *input = lua_touserdata(L, 1);
  int key_int = luaL_checkoption(L, 2, "KEY_UNKNOWN", binocle_input_keyboard_key_str);
  binocle_input_keyboard_key key = binocle_input_keyboard_key_val[key_int];
  bool res = binocle_input_is_key_down(*input->input, key);
  lua_pushboolean(L, res);
  return 1;
}

int l_binocle_input_is_key_up(lua_State *L) {
  l_binocle_input_t *input = lua_touserdata(L, 1);
  int key_int = luaL_checkoption(L, 2, "KEY_UNKNOWN", binocle_input_keyboard_key_str);
  binocle_input_keyboard_key key = binocle_input_keyboard_key_val[key_int];
  bool res = binocle_input_is_key_up(*input->input, key);
  lua_pushboolean(L, res);
  return 1;
}

int l_binocle_input_set_quit_requested(lua_State *L) {
  l_binocle_input_t *input = lua_touserdata(L, 1);
  bool v = lua_toboolean(L, 2);
  input->input->quit_requested = v;
  return 0;
}

int l_binocle_input_get_mouse_position(lua_State *L) {
  l_binocle_input_t *input = lua_touserdata(L, 1);
  l_binocle_camera_t *camera = lua_touserdata(L, 2);
  kmVec2 res = binocle_input_get_mouse_position(*input->input, *camera->camera);
  lua_pushnumber(L, res.x);
  lua_pushnumber(L, res.y);
  return 2;
}

int l_binocle_input_is_mouse_down(lua_State *L) {
  l_binocle_input_t *input = lua_touserdata(L, 1);
  int btn_int = luaL_checkoption(L, 2, "MOUSE_LEFT", binocle_input_mouse_button_str);
  binocle_input_mouse_button btn = binocle_input_mouse_button_val[btn_int];
  bool res = binocle_input_is_mouse_down(*input->input, btn);
  lua_pushboolean(L, res);
  return 1;
}

static const struct luaL_Reg input [] = {
  {"new", l_binocle_input_new},
  {"is_key_pressed", l_binocle_input_is_key_pressed},
  {"is_key_down", l_binocle_input_is_key_down},
  {"is_key_up", l_binocle_input_is_key_up},
  {"set_quit_requested", l_binocle_input_set_quit_requested},
  {"get_mouse_position", l_binocle_input_get_mouse_position},
  {"is_mouse_down", l_binocle_input_is_mouse_down},
  {NULL, NULL}
};

int luaopen_input(lua_State *L) {
  luaL_newlib(L, input);
  lua_setglobal(L, "input");
  luaL_newmetatable(L, "binocle_input");

  lua_newtable(L);
  for (int i = 0 ; binocle_input_keyboard_key_str[i] != NULL ; i++) {
    lua_pushstring(L, binocle_input_keyboard_key_str[i]);
    lua_pushstring(L, binocle_input_keyboard_key_str[i]);
    lua_settable(L, -3);
  }
  lua_setglobal(L, "key");

  lua_newtable(L);
  for (int i = 0 ; binocle_input_mouse_button_str[i] != NULL ; i++) {
    lua_pushstring(L, binocle_input_mouse_button_str[i]);
    lua_pushstring(L, binocle_input_mouse_button_str[i]);
    lua_settable(L, -3);
  }
  lua_setglobal(L, "mouse");

  lua_pop(L, 1);
  return 1;
}